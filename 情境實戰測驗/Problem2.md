# Problem 2

## Solution

先假設一些條件的定義:

1. 因為描述都是以 `機器` 來形容，故先理解成該 cluster 上的 services 是以 instance 方式進行服務而非 container。
2. `監控系統發現其中一台回應時間經常逾時，僅有此機器異常` 這句話理解成是某組 API(e.g. 下圖架構的 API-1 這組 Service) 有異常，而非已知 `API-1-* (instance)` 有異常(這 case 相對單純，最後補充)
3. 回應時間經常逾時，理解成問題可能是偶發。
4. 這狀況在之前沒有發生過，第一次遇到

在釐清定義後，理解該問題為某個 Service 的 response time 會偶發性 timeout，而該 service 可能不只一台 instance 提供服務，因此在該 Service 前面可能會有個 Load Balancer or Reverse Proxy 的角色，架構可能如下:

```txt
                         ┌─────────────────────────────────────────────────────┐
                         │                      API Cluster                    │
                         │    ┌─────────────────────┐                          │
                         │    │     LB/Proxy        │           ┌─────────┐    │
                         │    │                     │  ┌────────┤ API-1-1 │    │
                         │    │                     │  │        └─────────┘    │
                         │    │          ┌───────┐  │  │        ┌─────────┐    │
                         │    │    ┌─────┤ API-1 ├──┼──┼────────┤ API-1-2 │    │
                         │    │    │     └───────┘  │  │        └─────────┘    │
                         │    │    │     ┌───────┐  │  │        ┌─────────┐    │
                         │    │    ├─────┤ API-2 │  │  └────────┤ API-1-3 │    │
                         │    │    │     └───────┘  │           └─────────┘    │
┌──────┐   ┌───────────┐ │    │    │     ┌───────┐  │                          │
│Client├───│API─Gateway├─┼────┼────┼─────┤ API-3 │  │                          │
└──────┘   └───────────┘ │    │    │     └───────┘  │                          │
                         │    │    │         .      │                          │
                         │    │    │                │                          │
                         │    │    │         .      │                          │
                         │    │    │                │                          │
                         │    │    │         .      │                          │
                         │    │    │     ┌───────┐  │                          │
                         │    │    └─────┤ API-N │  │                          │
                         │    │          └───────┘  │                          │
                         │    │                     │                          │
                         │    │                     │                          │
                         │    └─────────────────────┘                          │
                         │                                                     │
                         └─────────────────────────────────────────────────────┘
```

假設現在的問題是 `API-1`這組服務會有偶發性的 response timeout，在經驗上會：

1. 如果已經存在 metrics 的監控，會先確認一下 resource 狀況(CPU/Memory/Load Average/networking...I/O 等)

   - 若運氣好看到 metric 趨勢異常，這邊大概可以鎖定有問題的 instance 並且先透過 LB 將有問題的 instance 移出先讓 production 恢復正常。

   - 接著從異常的 metrics 監控來判斷問題點:

     - 確認資源使用狀況是否有異常，例如非預期的 process

     - 如果都正常但是 main service 本身佔用的資源比其他台多，則進入 log 分析階段
       - 分析 access log 確認 response time 特別長的程式是否有特徵
       - application log 確認功能使否有 exception，到這邊可能可以發現一些特徵

2. 檢查跟 API-1 相依的服務(e.g. DB/storage/cache/api...)

   - 雖然只有單台異常，但如果在第一部分都還看不出問題，也會快速進行檢查確認，是否因為過去配置不當造成 lb 分配不均，致使因為某個相依服務的單台異常影響到。

3. 因為到這邊已經確認是哪一台 instance 造成異常，且不影響線上服務了，若是還找不到原因，我會選擇:

   - 先 reboot，再進行觀察，如果是 on-premise 有可能是某個硬體出問題，這就在針對硬體排查。
   - 如果在 cloud 上，最後再檢查一下是否是特定 region 或者 cloud 有異常公告，釐清是否為 cloud provider 問題。
     - 如果到這邊都還沒法處理，會先選擇 relaunch 一台新的 instance 再進行觀察，並記錄相關資訊用來做往後參考。

最後補充，假設題目的情境是已經知道後端特定 instance 會發生該異常狀況，就會直接對該 instance 進行系統狀況以及 log 分析來確認原因。

整理這個 case 在排查的思路會是先確保 production 服務穩定，再確認是哪個服務的哪台機器，再從監控數據以及歷史資料來進行快速釐清可能的問題，最後從 log 來確認問題點，並進行排除，如果無法在短時間內排除，則評估這個問題的嚴重程度與人力成本的權衡來決定採取措施。
